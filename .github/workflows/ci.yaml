---
name: CI Plugin workflow
on: 
  pull_request:
  push:
    tags:
      - 'v*.*.*'

jobs:
  linters:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Shellcheck - hack
        uses: azohra/shell-linter@latest
        with:
          path: "hack/*.sh"

      - name: Shellcheck - Plugin - openshift-tests
        uses: azohra/shell-linter@latest
        with:
          scandir: './tools/openshift-provider-cert-plugin/*.sh'

      - name: Shellcheck - Plugin - openshift-tests - hack
        uses: azohra/shell-linter@latest
        with:
          scandir: './tools/openshift-provider-cert-plugin/hack/*.sh'

#
# Plugin workflow check
#

#
# Tests related to plugin: openshift-tests
#
  plugin-openshift-tests-e2e:
    runs-on: ubuntu-latest
    needs:
      - linters
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: e2e
        run: |
          echo "e2e Not implemented."

  plugin-openshift-tests-build:
    if: ${{ needs.check.outputs.PLUGIN_CERT_CHANGED }} == "true"
    runs-on: ubuntu-latest
    needs:
      - linters
      - plugin-openshift-tests-e2e
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build Container image
        env:
          VERSION: "${{ needs.check.outputs.VERSION }}"
        run: |
          make build-ci

#
# Releasing
#
  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs:
      - plugin-openshift-tests-build
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set vars
        id: vars
        run: echo ::set-output name=tag::${GITHUB_REF#refs/*/}

      - name: Push Container image
        env:
          RELEASE_VERSION: ${{ steps.vars.outputs.tag }}
        run: |
          make release VERSION=$RELEASE_VERSION
